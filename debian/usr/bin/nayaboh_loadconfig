#!/bin/sh

# read to config file
INTERNET=$(grep internet-interface /etc/nayaboh.conf | cut -d\= -f2)
LOCALNET=$(grep internal-interface /etc/nayaboh.conf | cut -d\= -f2)

echo "INTERNET=$INTERNET LOCALNET=$LOCALNET"
echo "change /etc/dnsmasq.conf and /etc/nayaboh-iptables.up.rules"

# if there is an X-Display we use gksudo, otherwise just use sudo on terminal
if [ $DISPLAY ]; then

    # change e.g. "interface=eth1" to "interace=eth0", depending on the  nayaboh config file
    gksudo "sed -i 's/^interface=.*/interface=$LOCALNET/g' /etc/dnsmasq.conf"
    # similar change to a second parameter in dnsmasq.conf
    gksudo "sed -i 's/^no-dhcp-interface=.*/no-dhcp-interface=$INTERNET/g' /etc/dnsmasq.conf"

    # replace the string between -i and -p with the value of the nayaboh config file 
    gksudo "sed -i 's/-A PREROUTING -i .* -p/-A PREROUTING -i $LOCALNET -p/g' /etc/nayaboh-iptables.up.rules"
    # replace the string between -o and -j with the value of the nayaboh config file 
    gksudo "sed -i 's/-A POSTROUTING -o .* -j MASQUERADE/-A POSTROUTING -o $INTERNET -j MASQUERADE/g' /etc/nayaboh-iptables.up.rules"
else
    # do the same as above, but using sudo instead of gksudo
    sudo sed -i "s/^interface=.*/interface=$LOCALNET/g" /etc/dnsmasq.conf
    sudo sed -i "s/^no-dhcp-interface=.*/no-dhcp-interface=$INTERNET/g" /etc/dnsmasq.conf

    sudo sed -i "s/-A PREROUTING -i .* -p/-A PREROUTING -i $LOCALNET -p/g" /etc/nayaboh-iptables.up.rules
    sudo sed -i "s/-A POSTROUTING -o .* -j MASQUERADE/-A POSTROUTING -o $INTERNET -j MASQUERADE/g" /etc/nayaboh-iptables.up.rules
fi

####################
# RESTART SERVICES #
####################

# reload iptables
echo "### reload iptables"
sudo /etc/network/if-up.d/nayaboh-iptables

# DNSMASQ
echo "### restart dnsmasq"
# should try invoke-rc.d, like told here:
# http://www.debian.org/doc/debian-policy/ch-opersys.html#s9.3.3.2
if which invoke-rc.d >/dev/null 2>&1; then
    sudo invoke-rc.d dnsmasq restart
else
    sudo /etc/init.d/dnsmasq restart
fi

# SQUID
echo "### restart squid"
# because ubuntu 10.04 is using upstart for squid
# but debian does not I need to find out which system is used
if which initctl && initctl --version | grep -i upstart
    then
    echo "upstart installed, try use upstart..."
    echo "stopping squid..."
    # use Upstart-Stop only if squid is up!
    if ps aux | grep squid | grep -v grep
        then
        sudo service squid stop
        # then wait and check if squid is finally down
        sleep 5
        while ps aux | grep squid | grep -v grep
        do
            echo "squid is still up, waiting 3 seconds..."
            sleep 3
        done
    fi
    echo 'squid is down!'
    # I hate and/or don't understand Upstart...
    sleep 1
    echo "starting squid..."
    # ...at least starting is easy
    sudo service squid start
else
    echo "no upstart installed, try use init script..."
    # should try invoke-rc.d, like told here:
    # http://www.debian.org/doc/debian-policy/ch-opersys.html#s9.3.3.2
    if which invoke-rc.d >/dev/null 2>&1; then
        sudo invoke-rc.d squid restart
    else
        sudo /etc/init.d/squid restart
    fi
fi

exit 0

