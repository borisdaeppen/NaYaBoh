#!/bin/sh

NEW=$1

if test ! $1
    then
    echo 'Enter the first three numbers of your network of choice.'
    echo 'I mean the X in this example -> X.X.X.Z'
    echo -n "Enter your IP and press [ENTER]: "
    read NEW
fi

NET=$(grep network /etc/network/interfaces | awk '{ print $2 }' | cut -d. -f4 --complement)
echo "try to change '$NET' to '$NEW' in this files:"
echo "/usr/bin/nayaboh_benchmark /etc/squid/squid.conf /etc/network/interfaces /etc/dnsmasq.conf"
sudo sed -i "s/$NET/$NEW/g" /usr/bin/nayaboh_benchmark /etc/network/interfaces /etc/dnsmasq.conf
sudo sed -i '/nayaboh src/ d' /etc/squid/squid.conf # delete
sudo sed -i "3iacl nayaboh src $NEW.0/255.255.255.0" /etc/squid/squid.conf
echo ''
echo 'Changes took effect here:'
sudo grep -F $NEW /usr/bin/nayaboh_benchmark /etc/squid/squid.conf /etc/network/interfaces /etc/dnsmasq.conf
echo ''

echo "### restart network interfaces"
ifdown eth0
ifdown eth1
ifup eth0
ifup eth1
echo "### restart dnsmasq"
/etc/init.d/dnsmasq restart
echo "### restart squid"
# because ubuntu 10.04 is using upstart for squid
# but debian does not I need to find out which system is used
if which initctl && initctl --version | grep -i upstart
    then
    echo "upstart installed, try use upstart..."
    echo "stopping squid..."
    initctl stop squid
    sleep 5
    while ps aux | grep squid | grep -v grep
    do
        echo "squid is still up, waiting 3 seconds..."
        sleep 3
    done
    echo 'squid is down!'
    sleep 1
    echo "starting squid..."
    initctl start squid
else
    echo "no upstart installed, try use init script..."
    /etc/init.d/squid restart
fi

exit 0
